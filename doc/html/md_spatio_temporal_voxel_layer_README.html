<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Omniveyor: Spatio-Temporal Voxel Layer &lt;a href=&quot;http://build.ros.org/view/Kbin_uX64/job/Mdev__spatio_temporal_voxel_layer__ubuntu_bionic_amd64/&quot;&gt;&lt;img src=&quot;http://build.ros.org/buildStatus/icon?job=Mdev__spatio_temporal_voxel_layer__ubuntu_bionic_amd64&quot; alt=&quot;Build Status&quot;/&gt;&lt;/a&gt;</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Omniveyor
   </div>
   <div id="projectbrief">Root Repository for the OmniVeyor Robots</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Spatio-Temporal Voxel Layer <a href="http://build.ros.org/view/Kbin_uX64/job/Mdev__spatio_temporal_voxel_layer__ubuntu_bionic_amd64/"><img src="http://build.ros.org/buildStatus/icon?job=Mdev__spatio_temporal_voxel_layer__ubuntu_bionic_amd64" alt="Build Status" class="inline"/></a> </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This is a drop in replacement for the voxel_grid voxel representation of the environment. This package does a number of things to improve on the voxel grid package and extend the capabilities offered to the users, under a LGPL v2.1 license. Developed and maintained by <a href="https://www.linkedin.com/in/steven-macenski-41a985101/">Steven Macenski</a> at <a href="http://www.simberobotics.com/">Simbe Robotics</a>.</p>
<p>This package sits on top of <a href="http://www.openvdb.org/">OpenVDB</a>, an open-source C++ library built by Dreamworks "comprising a novel hierarchical data structure and a suite of tools for the efficient storage and manipulation of sparse volumetric data discretized on three-dimensional grids. It is developed and maintained by DreamWorks Animation for use in volumetric applications typically encountered in feature film production."</p>
<p>Leveraging OpenVDB, we have the ability to efficiently maintain a 3 dimensional voxel-representative world space. We wrap this with ROS tools and interfaces to the <a href="http://wiki.ros.org/navigation">navigation stack</a> to allow for use of this layer in standard ROS configurations. It is certainly possible to utilize this package without ROS/Navigation and I invite other competing methodologies to develop here and create interfaces.</p>
<p>Sample videos are shown below of a robot using <b>7 depth cameras</b> with less than 50% of a core, and another robot using a <b>VLP-16</b>.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">7 Depth Cameras </th><th class="markdownTableHeadCenter">VLP-16 LIDAR  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter"><img src="https://user-images.githubusercontent.com/14944147/37010885-b18fe1f8-20bb-11e8-8c28-5b31e65f2844.gif" alt="ezgif com-video-to-gif" class="inline"/> </td><td class="markdownTableBodyCenter"><img src="https://github.com/nickovaras/gifs/blob/master/follow.gif?raw=true" alt="vlp16" class="inline"/>  </td></tr>
</table>
<p>We found in experimental trials with <b>6</b> 7hz dense stereo RGBD cameras we ran the major move_base process at <b>20-50%</b> nominal from <b>80-110%</b> on a 5th gen i7 CPU in the global costmap updating using the existing <code>voxel_layer</code>.</p>
<p>We've received feedback from users and have robots operating in the following environments with STVL:</p><ul>
<li>Retail</li>
<li>Warehouses</li>
<li>Factories</li>
<li>Libraries</li>
<li>Hospitals</li>
<li>Hospitality</li>
<li>RoboCup@Home</li>
<li>Oil and Gas</li>
</ul>
<p>Steve spoke at ROSCon 2018 about STVL and his presentation is <a href="https://vimeo.com/292699571">linked here</a> (or click on image).</p>
<p><a href="https://vimeo.com/292699571"><img src="https://user-images.githubusercontent.com/14944147/46768837-987c9280-cc9e-11e8-99ea-788d3d590dd8.png" alt="IMAGE ALT TEXT" class="inline"/></a></p>
<h2><a class="anchor" id="autotoc_md38"></a>
Cite This Work</h2>
<div class="fragment"><div class="line">@article{doi:10.1177/1729881420910530,</div>
<div class="line">    author = {Steve Macenski and David Tsai and Max Feinberg},</div>
<div class="line">    title ={Spatio-temporal voxel layer: A view on robot perception for the dynamic world},</div>
<div class="line">    journal = {International Journal of Advanced Robotic Systems},</div>
<div class="line">    volume = {17},</div>
<div class="line">    number = {2},</div>
<div class="line">    year = {2020},</div>
<div class="line">    doi = {10.1177/1729881420910530},</div>
<div class="line">    URL = {https://doi.org/10.1177/1729881420910530}</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md39"></a>
&lt;strong&gt;Spatio&lt;/strong&gt;-</h1>
<p>The Spatio in this package is the representation of the environment in a configurable <code>voxel_size</code> voxel grid stored and searched by OpenVDB.</p>
<p>In addition, buffered measurement readings have the option to run an approximate voxel grid filter, parameterizable at runtime in the configuration yamls. It is incredibly useful to reduce spikes in <code>move_base</code> cpu due to dense measurement readings when getting close to objects (i.e. more points), but does increase the overhead very slightly (1-2%) for nominal operations. It's a trade off but I recommend using it.</p>
<p>Below is an example a size of map that is <b>trivial</b> for the Spatio-Temportal Voxel Grid to maintain and render. This accounts for a 60,000 sq.ft. retail store with 710,765 voxels at a 0.05m resolution, with a size in memory of a mere 6.45MB. <br  />
</p>
<p><img src="https://user-images.githubusercontent.com/14944147/37013097-11e4f782-20c6-11e8-8212-6fca6e54331c.png" alt="full_sore" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md40"></a>
-**Temporal**</h1>
<p>The Temporal in this package is the novel concept of <code>voxel_decay</code> whereas we have configurable functions that expire voxels and their occupation over time. Infrasture was created to store times in each voxel after which the voxel will disappear from the map. This is combined with checking inclusion of voxels in current measurement frustums to accelerate the decay of those voxels that do not have measurements but should if still in the scene and remain marked. This is done rather than simply clearing them naively or via costly raytracing. The time it takes to clear depends on the configured functions and acceleration factors.</p>
<p>Voxel acceleration uses given FOV to compute the frustum geometry. Depth cameras (e.g. Intel Realsense) are modeled with traditional 6-planed cubical frustums. 3D lidars (e.g. Velodyne VLP 16) are modeled with their hourglass-shaped FOV. Although many 3D lidars have 360 degree horizontal FOV, it is possible to use a narrower angle for the clearing frustum by setting the hFOV parameter accordingly.</p>
<p>Future extensions will also to query a static map and determine which connected components belong to the map, not in the map, or moving. Each of these three classes of blobs will have configurable models to control the time they persist, and if these things are reported to the user.</p>
<p>Below is an example of instantaneous decay, where readings in frustum are accelerated and decayed at each iteration. The models provided can be tuned to do this, or persist through linear or exponental equations. The second example has the acclerated frustum with tuned decay times and acceleration factors in navigation mode.</p>
<p><img src="https://user-images.githubusercontent.com/14944147/37063574-d0923d24-2167-11e8-850c-18b6aed61634.gif" alt="ezgif com-video-to-gif 1" class="inline"/></p>
<p><img src="https://user-images.githubusercontent.com/14944147/37127014-cacc1d1c-2241-11e8-8c2e-6ff7341333c9.gif" alt="ezgif com-video-to-gif 3" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md41"></a>
Local Costmap</h1>
<p>This package utilizes all of the information coming in from the robot before the decay time for the local costmap. Rather than having a defined, discrete spatial barrier for the local planner to operate in, it instead relies on the user configuration of the layer to have a short decay time of voxels (1-30 seconds) so that you only plan in relavent space. This was a conscious design requirement since frequently the local planner should operate with more information than other times when the speed is greater or slower. This natively implements dynamic costmap scaling for speed.</p>
<p>It is the user's responsibility to chose a decay time that makes sense for your robot's local planner. 5-15 seconds I have found to be nominally good for most open-sourced local planner plugins. I do not recommend using this for planar lidars, 2D raytracing for professional grade lidars is sufficiently efficient and effective.</p>
<h1><a class="anchor" id="autotoc_md42"></a>
Global Costmap</h1>
<p>Similar to the local costmap, the amount of information you want to store due to entropy in your scenes depend on your use-case. It is certainly possible to <b>not</b> decay the voxels in the global map at all. However, in practical application, I find a time 15-45 seconds to be a good balance due to things moving in the scene (i.e. store, warehouse, construction zone, office, etc). Permanent voxels set decay to -1. I do not recommend using this for planar lidars, 2D raytracing for professional grade lidars is sufficiently efficient and effective.</p>
<h1><a class="anchor" id="autotoc_md43"></a>
Mapping</h1>
<p>As the images above suggest, you can use this to map an environment in 3D in realtime if you choose. If you enable mapping mode, then it will maintain the entire voxel grid and you can save the map using the services provided. At the moment, I support mapping but there is no probabilistic (yet!) marking framework, so what the sensor sees is what the map gets. This is likely to change in the near to middle term future as 3D localization becomes more interesting to the enterprise robotics community.</p>
<p>You can run multiple instances of the layer one to map and other to navigate if you want to navigate while mapping the environment. Mapping will also save incremental maps in the launch directory. Maps may be visualized using <code>vdb_viewer</code>. The costmap and occupancy point clouds will not generate in this mode from this layer. Utility functions are provided so you don't need to learn anything about vdb files to convert to a pcl pointcloud in <code><a class="el" href="vdb2pc_8hpp.html">vdb2pc.hpp</a></code>.</p>
<p>If you would like to be involved in this work, I would gladly take contributors and coauthors.</p>
<h1><a class="anchor" id="autotoc_md44"></a>
Installation</h1>
<p>As of July 8 it is available via <code>apt-get</code>: </p><div class="fragment"><div class="line">sudo apt-get install ros-kinetic-spatio-temporal-voxel-layer</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md45"></a>
Install from source</h2>
<p>Required dependencies ROS Kinetic, navigation, OpenVDB, TBB.</p>
<p><code>sudo rosdep init &amp;&amp; rosdep update &amp;&amp; rosdep install --from-paths src --ignore-src -r -y</code></p>
<h1><a class="anchor" id="autotoc_md46"></a>
Configuration and Running</h1>
<h2><a class="anchor" id="autotoc_md47"></a>
costmap_common_params.yaml</h2>
<p>An example fully-described configuration is shown below.</p>
<p>Note: We supply two PCL filters within STVL to massage the data to lower compute overhead. STVL has an approximate voxel filter to make the data more sparse if very dense. It also has a passthrough filter to limit processing data within the valid minimum to maximum height bounds. The voxel filter is recommended if it lowers CPU overhead, otherwise, passthrough filter. No filter is also available if you pre-process your data or are not interested in performance optimizations.</p>
<div class="fragment"><div class="line">rgbd_obstacle_layer:</div>
<div class="line">  enabled:               true</div>
<div class="line">  voxel_decay:           20     #seconds if linear, e^n if exponential</div>
<div class="line">  decay_model:           0      #0=linear, 1=exponential, -1=persistent</div>
<div class="line">  voxel_size:            0.05   #meters</div>
<div class="line">  track_unknown_space:   true   #default space is unknown</div>
<div class="line">  observation_persistence: 0.0  #seconds</div>
<div class="line">  max_obstacle_height:   2.0    #meters</div>
<div class="line">  unknown_threshold:     15     #voxel height</div>
<div class="line">  mark_threshold:        0      #voxel height</div>
<div class="line">  update_footprint_enabled: true</div>
<div class="line">  combination_method:    1      #1=max, 0=override</div>
<div class="line">  obstacle_range:        3.0    #meters</div>
<div class="line">  origin_z:              0.0    #meters</div>
<div class="line">  publish_voxel_map:     true   # default off</div>
<div class="line">  transform_tolerance:   0.2    # seconds</div>
<div class="line">  mapping_mode:          false  # default off, saves map not for navigation</div>
<div class="line">  map_save_duration:     60     #default 60s, how often to autosave</div>
<div class="line">  observation_sources:   rgbd1_clear rgbd1_mark</div>
<div class="line">  rgbd1_mark:</div>
<div class="line">    data_type: PointCloud2</div>
<div class="line">    topic: camera1/depth/points</div>
<div class="line">    marking: true</div>
<div class="line">    clearing: false</div>
<div class="line">    min_obstacle_height: 0.3     #default 0, meters</div>
<div class="line">    max_obstacle_height: 2.0     #defaule 3, meters</div>
<div class="line">    expected_update_rate: 0.0    #default 0, if not updating at this rate at least, remove from buffer</div>
<div class="line">    observation_persistence: 0.0 #default 0, use all measurements taken during now-value, 0=latest </div>
<div class="line">    inf_is_valid: false          #default false, for laser scans</div>
<div class="line">    clear_after_reading: true    #default false, clear the buffer after the layer gets readings from it</div>
<div class="line">    filter: &quot;voxel&quot;              #default passthrough, apply &quot;voxel&quot;, &quot;passthrough&quot;, or no filter to sensor data, recommended to have at one filter on</div>
<div class="line">    voxel_min_points: 0          #default 0, minimum points per voxel for voxel filter</div>
<div class="line">  rgbd1_clear:</div>
<div class="line">    enabled: true                #default true, can be toggled on/off with associated service call</div>
<div class="line">    data_type: PointCloud2</div>
<div class="line">    topic: camera1/depth/points</div>
<div class="line">    marking: false</div>
<div class="line">    clearing: true</div>
<div class="line">    min_z: 0.1                   #default 0, meters</div>
<div class="line">    max_z: 7.0                   #default 10, meters</div>
<div class="line">    vertical_fov_angle: 0.7      #default 0.7, radians</div>
<div class="line">    horizontal_fov_angle: 1.04   #default 1.04, radians</div>
<div class="line">    decay_acceleration: 1.       #default 0, 1/s^2. If laser scanner MUST be 0</div>
<div class="line">    model_type: 0                #default 0 (depth camera). Use 1 for 3D Lidar</div>
</div><!-- fragment --><p>More configuration samples are included in the example folder, including a 3D lidar one.</p>
<h2><a class="anchor" id="autotoc_md48"></a>
local/global_costmap_params.yaml</h2>
<p>Add this plugin to your costmap params file.</p>
<p><code>- {name: rgbd_obstacle_layer, type: "spatio_temporal_voxel_layer/SpatioTemporalVoxelLayer"}</code></p>
<h2><a class="anchor" id="autotoc_md49"></a>
Running</h2>
<p><code>roslaunch [navigation_pkg] move_base.launch</code></p>
<h2><a class="anchor" id="autotoc_md50"></a>
Enabing/disabling observation_sources real-time</h2>
<p>To enable/disable observation sources use a ros service for each source:</p>
<p>~rgbd_obstacle_layer//toggle_enabled (std_srvs/SetBool)</p><ul>
<li>request.data = true // Enable observation source</li>
<li>request.data = false // Disable observation source</li>
</ul>
<p>Example: </p><div class="fragment"><div class="line">rosservice call /move_base/global_costmap/rgbd_obstacle_layer/rgbd_back/toggle_enabled &quot;data: true&quot;</div>
<div class="line">rosservice call /move_base/local_costmap/rgbd_obstacle_layer/rgbd_back/toggle_enabled &quot;data: false&quot;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md51"></a>
Debug and Model Fitting</h2>
<p>I have made the frustum transformations available for visualization and debugging. You may enable them by the <code>VISUALIZE_FRUSTUM</code> macro, though be aware it takes a substantial decrease on performance since we're creating and destroying a ros publisher at a non-trivial rate.</p>
<p>This can also be used for situations where you do not know your camera's proper frustum FOVs. It is possible to enable it and tweek the FOVs until you get the appropriate coverage of the space your sensor carves out in the global space. You should only do this with one sensor at a time or else your frustum in rviz might jitter around. ;-)</p>
<h2><a class="anchor" id="autotoc_md52"></a>
Interesting side note</h2>
<p>We are able to iterate over very large grids for voxel decay, however there is clearly for every frequency (running at 1, 5, 10, 100hz) an upper limit. In the image below, we don't actually hit the limit of the data structure, but iterating at 2hz, we hit the limit of ROS' ability to publish a sufficiently large point cloud in that time period, we are still running but you can see the robot at the end of an aisle without occupancy points, but still costmap marking from the underlying grid.</p>
<p>To counter this I include a service to save the grid in the .vdb format for later visualization, and for this reason I do not recommend visualizing the grid during nominal operations unless your decay time is relatively low (0-15 seconds) or else the layer may not meet its frequency requirements due to publishing this massive pointcloud.</p>
<p><img src="https://user-images.githubusercontent.com/14944147/37010656-8ce4ff4c-20ba-11e8-9c35-1ce3e3039f77.png" alt="openvdb2" class="inline"/> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
